{
  "id": "lua-api-event-architecture",
  "title": "Event-Driven Architecture",
  "slug": "event-architecture",
  "version": "build-41",
  "section": "modding",
  "category": "lua-api",
  "tags": [
    "lua",
    "item",
    "weapon",
    "event",
    "architecture"
  ],
  "content": "# Event-Driven Architecture\r\n\r\n## DAMN's Event System Design\r\n\r\nThe DAMN library demonstrates a robust event-driven pattern for handling game state changes and synchronization.\r\n\r\n---\r\n\r\n## 1. Event Registration Pattern\r\n\r\n### Player Vehicle Events\r\n\r\n```lua\r\n-- Player enters vehicle → Register update handler\r\nEvents.OnEnterVehicle.Add(function(player)\r\n    local vehicle = player:getVehicle();\r\n    DAMN[\"currentVehicle\"] = vehicle;\r\n    Events.OnPlayerUpdate.Add(DAMN.inVehicleUpdateTask);\r\nend);\r\n\r\n-- Player update tick → Execute armor code\r\nfunction DAMN.inVehicleUpdateTask(player)\r\n    if DAMN.Armor[\"byVehicleScript\"][DAMN[\"currentVehicleScript\"]] then\r\n        DAMN.Armor:runArmorCode(player, DAMN[\"currentVehicle\"]);\r\n    end\r\nend\r\n\r\n-- Player exits vehicle → Cleanup\r\nEvents.OnExitVehicle.Add(function(player)\r\n    DAMN.Armor:flushPartsBuffer(DAMN[\"currentVehicle\"], nil, true);\r\n    Events.OnPlayerUpdate.Remove(DAMN.inVehicleUpdateTask);\r\nend);\r\n```\r\n\r\n---\r\n\r\n## 2. Key Project Zomboid Events\r\n\r\n### Combat Events\r\n\r\n```lua\r\n-- When player swings a weapon\r\nEvents.OnWeaponSwing.Add(function(playerObj, weapon)\r\n    -- Track weapon usage, apply effects\r\nend);\r\n\r\n-- When a zombie dies\r\nEvents.OnZombieDead.Add(function(zombie)\r\n    -- Check if player killed it, track kills\r\nend);\r\n\r\n-- When player hits a zombie\r\nEvents.OnWeaponHitCharacter.Add(function(wielder, target, weapon, damage)\r\n    -- Track damage dealt, apply special effects\r\nend);\r\n\r\n-- When player hits a tree (for axe-type weapons)\r\nEvents.OnWeaponHitTree.Add(function(wielder, weapon)\r\n    -- Track usage for non-combat weapons\r\nend);\r\n```\r\n\r\n### Equipment Events\r\n\r\n```lua\r\n-- When item is equipped to primary hand\r\nEvents.OnEquipPrimary.Add(function(player, item)\r\n    -- Initialize weapon tracking, apply buffs\r\nend);\r\n\r\n-- When item is equipped to secondary hand\r\nEvents.OnEquipSecondary.Add(function(player, item)\r\n    -- Handle off-hand items\r\nend);\r\n```\r\n\r\n### Input Events\r\n\r\n```lua\r\n-- Keyboard input\r\nEvents.OnKeyPressed.Add(function(key)\r\n    -- Handle hotkey presses for UI, abilities\r\nend);\r\n\r\nEvents.OnKeyStartPressed.Add(function(key)\r\n    -- Handle key down event\r\nend);\r\n```\r\n\r\n### Player Events\r\n\r\n```lua\r\n-- Player update tick (runs every frame)\r\nEvents.OnPlayerUpdate.Add(function(player)\r\n    -- Continuous updates (use sparingly - performance impact)\r\nend);\r\n\r\n-- Player death\r\nEvents.OnPlayerDeath.Add(function(player)\r\n    -- Save weapon state, cleanup\r\nend);\r\n\r\n-- Game tick (runs every game tick)\r\nEvents.OnTick.Add(function()\r\n    -- Less frequent than OnPlayerUpdate\r\nend);\r\n```\r\n\r\n### UI Events\r\n\r\n```lua\r\n-- Fill inventory context menu\r\nEvents.OnFillInventoryObjectContextMenu.Add(function(player, context, items)\r\n    -- Add custom context menu options for weapons\r\nend);\r\n\r\n-- Pre-fill context menu (for adding options before vanilla)\r\nEvents.OnPreFillInventoryObjectContextMenu.Add(function(player, context, items)\r\n    -- Add custom options\r\nend);\r\n```\r\n\r\n---\r\n\r\n## 3. Client-Server Event Pattern\r\n\r\n### Client Command Events\r\n\r\n```lua\r\n-- Server listens for client commands\r\nEvents.OnClientCommand.Add(function(moduleName, command, playerObj, args)\r\n    if moduleName == \"your_mod\" then\r\n        if command == \"upgradeWeapon\" then\r\n            HandleWeaponUpgrade(playerObj, args);\r\n        elseif command == \"applyEnchant\" then\r\n            HandleEnchant(playerObj, args);\r\n        end\r\n    end\r\nend);\r\n```\r\n\r\n### Server Command Events\r\n\r\n```lua\r\n-- Client listens for server responses\r\nEvents.OnServerCommand.Add(function(moduleName, command, args)\r\n    if moduleName == \"your_mod\" then\r\n        if command == \"weaponUpgraded\" then\r\n            ShowUpgradeNotification(args);\r\n        end\r\n    end\r\nend);\r\n```\r\n\r\n---\r\n\r\n## 4. Implementing for Outcast Weapons\r\n\r\n### Weapon Event Handler Setup\r\n\r\n```lua\r\n-- Initialize namespace\r\nOutcastWeapons = OutcastWeapons or {};\r\nOutcastWeapons.trackedWeapons = {};\r\n\r\n-- Track weapon equip\r\nEvents.OnEquipPrimary.Add(function(player, item)\r\n    if item and IsOutcastWeapon(item) then\r\n        OutcastWeapons:initializeWeapon(player, item);\r\n        Events.OnPlayerUpdate.Add(OutcastWeapons.weaponUpdateTask);\r\n    end\r\nend);\r\n\r\n-- Track weapon unequip/swap\r\nEvents.OnEquipPrimary.Add(function(player, item)\r\n    -- Check if OLD weapon was tracked\r\n    local oldWeapon = OutcastWeapons.trackedWeapons[player:getUsername()];\r\n    if oldWeapon and oldWeapon ~= item then\r\n        OutcastWeapons:saveWeaponState(oldWeapon);\r\n        Events.OnPlayerUpdate.Remove(OutcastWeapons.weaponUpdateTask);\r\n    end\r\nend);\r\n\r\n-- Initialize weapon tracking\r\nfunction OutcastWeapons:initializeWeapon(player, weapon)\r\n    local modData = weapon:getModData();\r\n\r\n    -- Initialize tracking data if not present\r\n    if not modData[\"OutcastInitialized\"] then\r\n        modData[\"OutcastInitialized\"] = true;\r\n        modData[\"OutcastTier\"] = modData[\"OutcastTier\"] or \"Common\";\r\n        modData[\"OutcastKillCount\"] = modData[\"OutcastKillCount\"] or 0;\r\n        modData[\"OutcastDamageDealt\"] = modData[\"OutcastDamageDealt\"] or 0;\r\n    end\r\n\r\n    self.trackedWeapons[player:getUsername()] = weapon;\r\nend\r\n```\r\n\r\n### Kill Tracking\r\n\r\n```lua\r\n-- Track zombie kills for weapon progression\r\nEvents.OnZombieDead.Add(function(zombie)\r\n    local player = getPlayer();\r\n    if not player then return; end\r\n\r\n    local weapon = player:getPrimaryHandItem();\r\n    if weapon and IsOutcastWeapon(weapon) then\r\n        local modData = weapon:getModData();\r\n        modData[\"OutcastKillCount\"] = (modData[\"OutcastKillCount\"] or 0) + 1;\r\n\r\n        -- Check tier thresholds\r\n        OutcastWeapons:checkTierProgression(player, weapon);\r\n    end\r\nend);\r\n```\r\n\r\n### Damage Tracking\r\n\r\n```lua\r\n-- Track damage for stats\r\nEvents.OnWeaponHitCharacter.Add(function(wielder, target, weapon, damage)\r\n    if wielder:isLocalPlayer() and IsOutcastWeapon(weapon) then\r\n        local modData = weapon:getModData();\r\n        modData[\"OutcastDamageDealt\"] = (modData[\"OutcastDamageDealt\"] or 0) + damage;\r\n    end\r\nend);\r\n```\r\n\r\n### Context Menu Integration\r\n\r\n```lua\r\n-- Add upgrade option to context menu\r\nEvents.OnFillInventoryObjectContextMenu.Add(function(playerNum, context, items)\r\n    local player = getSpecificPlayer(playerNum);\r\n\r\n    for _, item in ipairs(items) do\r\n        -- Handle both single items and stacks\r\n        local testItem = item;\r\n        if not instanceof(item, \"InventoryItem\") then\r\n            testItem = item.items[1];\r\n        end\r\n\r\n        if IsOutcastWeapon(testItem) then\r\n            local modData = testItem:getModData();\r\n\r\n            -- Add \"View Stats\" option\r\n            context:addOption(\"View Outcast Stats\", testItem, function(weapon)\r\n                OutcastWeapons:showStatsUI(player, weapon);\r\n            end);\r\n\r\n            -- Add \"Upgrade\" option if eligible\r\n            if OutcastWeapons:canUpgrade(testItem) then\r\n                context:addOption(\"Upgrade Weapon\", testItem, function(weapon)\r\n                    OutcastWeapons:performUpgrade(player, weapon);\r\n                end);\r\n            end\r\n        end\r\n    end\r\nend);\r\n```\r\n\r\n---\r\n\r\n## 5. Event Cleanup Pattern\r\n\r\nAlways remove event handlers when no longer needed:\r\n\r\n```lua\r\n-- Store reference to handler function\r\nOutcastWeapons.updateHandler = function(player)\r\n    -- Update logic\r\nend;\r\n\r\n-- Add handler\r\nEvents.OnPlayerUpdate.Add(OutcastWeapons.updateHandler);\r\n\r\n-- Remove when done (important for performance!)\r\nEvents.OnPlayerUpdate.Remove(OutcastWeapons.updateHandler);\r\n```\r\n\r\n---\r\n\r\n## 6. Multiplayer Synchronization Events\r\n\r\n### Sending Updates to Server\r\n\r\n```lua\r\nfunction OutcastWeapons:syncToServer(weapon)\r\n    local modData = weapon:getModData();\r\n    sendClientCommand(\r\n        getPlayer(),\r\n        \"OutcastWeapons\",\r\n        \"syncWeaponData\",\r\n        {\r\n            weaponId = weapon:getID(),\r\n            tier = modData[\"OutcastTier\"],\r\n            killCount = modData[\"OutcastKillCount\"],\r\n            damageDealt = modData[\"OutcastDamageDealt\"]\r\n        }\r\n    );\r\nend\r\n```\r\n\r\n### Server Handler\r\n\r\n```lua\r\n-- Server-side handler\r\nEvents.OnClientCommand.Add(function(moduleName, command, playerObj, args)\r\n    if moduleName == \"OutcastWeapons\" then\r\n        if command == \"syncWeaponData\" then\r\n            -- Validate and process\r\n            local weapon = playerObj:getInventory():getItemById(args.weaponId);\r\n            if weapon then\r\n                local modData = weapon:getModData();\r\n                modData[\"OutcastTier\"] = args.tier;\r\n                modData[\"OutcastKillCount\"] = args.killCount;\r\n                -- Server is authoritative - could validate here\r\n            end\r\n        elseif command == \"requestUpgrade\" then\r\n            -- Server validates and performs upgrade\r\n            OutcastWeapons:serverPerformUpgrade(playerObj, args);\r\n        end\r\n    end\r\nend);\r\n```\r\n",
  "excerpt": "The DAMN library demonstrates a robust event-driven pattern for handling game state changes and synchronization.\r\n\r\n---\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n---\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n---\r\n\r\n\r\n\r\n...",
  "lastUpdated": "2026-01-09",
  "difficulty": "intermediate",
  "tableOfContents": [
    {
      "id": "damns-event-system-design",
      "text": "DAMN's Event System Design",
      "level": 2
    },
    {
      "id": "1-event-registration-pattern",
      "text": "1. Event Registration Pattern",
      "level": 2
    },
    {
      "id": "player-vehicle-events",
      "text": "Player Vehicle Events",
      "level": 3
    },
    {
      "id": "2-key-project-zomboid-events",
      "text": "2. Key Project Zomboid Events",
      "level": 2
    },
    {
      "id": "combat-events",
      "text": "Combat Events",
      "level": 3
    },
    {
      "id": "equipment-events",
      "text": "Equipment Events",
      "level": 3
    },
    {
      "id": "input-events",
      "text": "Input Events",
      "level": 3
    },
    {
      "id": "player-events",
      "text": "Player Events",
      "level": 3
    },
    {
      "id": "ui-events",
      "text": "UI Events",
      "level": 3
    },
    {
      "id": "3-client-server-event-pattern",
      "text": "3. Client-Server Event Pattern",
      "level": 2
    },
    {
      "id": "client-command-events",
      "text": "Client Command Events",
      "level": 3
    },
    {
      "id": "server-command-events",
      "text": "Server Command Events",
      "level": 3
    },
    {
      "id": "4-implementing-for-outcast-weapons",
      "text": "4. Implementing for Outcast Weapons",
      "level": 2
    },
    {
      "id": "weapon-event-handler-setup",
      "text": "Weapon Event Handler Setup",
      "level": 3
    },
    {
      "id": "kill-tracking",
      "text": "Kill Tracking",
      "level": 3
    },
    {
      "id": "damage-tracking",
      "text": "Damage Tracking",
      "level": 3
    },
    {
      "id": "context-menu-integration",
      "text": "Context Menu Integration",
      "level": 3
    },
    {
      "id": "5-event-cleanup-pattern",
      "text": "5. Event Cleanup Pattern",
      "level": 2
    },
    {
      "id": "6-multiplayer-synchronization-events",
      "text": "6. Multiplayer Synchronization Events",
      "level": 2
    },
    {
      "id": "sending-updates-to-server",
      "text": "Sending Updates to Server",
      "level": 3
    },
    {
      "id": "server-handler",
      "text": "Server Handler",
      "level": 3
    }
  ]
}
{
  "id": "lua-api-item-modification",
  "title": "Item Modification & Transmogrification Patterns",
  "slug": "item-modification",
  "version": "build-41",
  "section": "modding",
  "category": "lua-api",
  "tags": [
    "lua",
    "item",
    "weapon",
    "event",
    "crafting",
    "modification",
    "patterns"
  ],
  "content": "# Item Modification & Transmogrification Patterns\r\n\r\n## Overview\r\n\r\nDAMN implements **item metamorphosis** through crafting, condition-based transformations, and runtime property modification. These patterns are directly applicable to weapon tier transformations.\r\n\r\n---\r\n\r\n## 1. Condition-Based Item Transformation\r\n\r\n### Pattern: Create Different Item Based on Condition\r\n\r\nFrom `DAMN_damnCraft.lua`:\r\n\r\n```lua\r\nfunction DAMN.OnCreate.DismantleTireSmall(items, result, player, selectedItem)\r\n    local tireCond = selectedItem:getCondition();\r\n\r\n    -- Determine output type based on input condition\r\n    if tireCond < 26 then\r\n        addType = \"damnCraft.TireRubberDestroyedSmall\"\r\n    elseif tireCond < 81 then\r\n        addType = \"damnCraft.TireRubberUsedSmall\"\r\n    else\r\n        addType = \"damnCraft.TireRubberNewSmall\"\r\n    end\r\n\r\n    -- Create new item and transfer condition\r\n    local tire = player:getInventory():AddItem(addType);\r\n    tire:setCondition(tireCond);\r\n\r\n    -- Award XP for the transformation\r\n    player:getXp():AddXP(Perks.Mechanics, 3);\r\nend\r\n```\r\n\r\n### Application to Weapon Tiers\r\n\r\n```lua\r\n-- Example: Transform weapon based on kill count or condition\r\nfunction TransformWeaponTier(player, weapon)\r\n    local modData = weapon:getModData();\r\n    local killCount = modData[\"OutcastKillCount\"] or 0;\r\n\r\n    local newType;\r\n    if killCount >= 100 then\r\n        newType = \"Outcast.GraveIndex_Legendary\"\r\n    elseif killCount >= 50 then\r\n        newType = \"Outcast.GraveIndex_Epic\"\r\n    elseif killCount >= 25 then\r\n        newType = \"Outcast.GraveIndex_Rare\"\r\n    else\r\n        return nil;  -- No transformation\r\n    end\r\n\r\n    -- Create new tiered weapon\r\n    local newWeapon = player:getInventory():AddItem(newType);\r\n\r\n    -- Transfer properties from old weapon\r\n    newWeapon:setCondition(weapon:getCondition());\r\n    newWeapon:getModData()[\"OutcastKillCount\"] = killCount;\r\n\r\n    -- Remove old weapon\r\n    player:getInventory():Remove(weapon);\r\n\r\n    return newWeapon;\r\nend\r\n```\r\n\r\n---\r\n\r\n## 2. Part Installation & Modification\r\n\r\n### Pattern: Silent Part Install (DAMN_Commands.lua)\r\n\r\n```lua\r\nfunction DAMN.Commands.silentPartInstall(playerObj, args)\r\n    -- Create item from type string\r\n    item = InventoryItemFactory.CreateItem(args[\"item\"]);\r\n    part = args[\"_vehicle\"]:getPartById(args[\"part\"]);\r\n\r\n    if part and item then\r\n        -- Install item into part\r\n        part:setInventoryItem(item);\r\n        args[\"_vehicle\"]:transmitPartItem(part);\r\n\r\n        -- Call completion handler if defined\r\n        local installTable = part:getTable(\"install\");\r\n        if installTable and installTable[\"complete\"] then\r\n            VehicleUtils.callLua(installTable[\"complete\"], args[\"_vehicle\"], part);\r\n        end\r\n\r\n        -- Apply condition and stats\r\n        part:setRandomCondition(item);\r\n        part:doInventoryItemStats(part:getInventoryItem(), part:getMechanicSkillInstaller());\r\n        args[\"_vehicle\"]:transmitPartCondition(part);\r\n    end\r\nend\r\n```\r\n\r\n### Application: Weapon Attachment System\r\n\r\n```lua\r\n-- Apply attachment to weapon, modifying its stats\r\nfunction ApplyWeaponAttachment(player, weapon, attachment)\r\n    local modData = weapon:getModData();\r\n\r\n    -- Track installed attachments\r\n    modData[\"OutcastAttachments\"] = modData[\"OutcastAttachments\"] or {};\r\n    table.insert(modData[\"OutcastAttachments\"], attachment:getFullType());\r\n\r\n    -- Modify weapon stats based on attachment\r\n    local attachmentType = attachment:getFullType();\r\n    if attachmentType == \"Outcast.DamageGem\" then\r\n        modData[\"OutcastDamageBonus\"] = (modData[\"OutcastDamageBonus\"] or 0) + 0.1;\r\n    elseif attachmentType == \"Outcast.SpeedGem\" then\r\n        modData[\"OutcastSpeedBonus\"] = (modData[\"OutcastSpeedBonus\"] or 0) + 0.15;\r\n    end\r\n\r\n    -- Remove attachment from inventory\r\n    player:getInventory():Remove(attachment);\r\nend\r\n```\r\n\r\n---\r\n\r\n## 3. Armor/Durability Modification System\r\n\r\n### Pattern: Buffered Condition Updates (DAMN_Armor_Client.lua)\r\n\r\n```lua\r\nfunction DAMN.Armor:setPartCondition(part, condition)\r\n    part:setCondition(condition);\r\n    -- Buffer changes for batch sync\r\n    DAMN.Armor[\"partUpdateBuffer\"][part:getId()] = condition;\r\nend\r\n\r\n-- Flush buffer to server\r\nfunction DAMN.Armor:flushPartsBuffer(vehicle, player, onExitVehicle)\r\n    if next(DAMN.Armor[\"partUpdateBuffer\"]) then\r\n        DAMN:sendLibCommand(\"updatePartConditions\", {\r\n            conditions = DAMN.Armor[\"partUpdateBuffer\"],\r\n        }, vehicle);\r\n        DAMN.Armor[\"partUpdateBuffer\"] = {};\r\n    end\r\nend\r\n```\r\n\r\n### Application: Weapon Durability System\r\n\r\n```lua\r\n-- Track weapon wear with buffered updates\r\nOutcastWeapons = OutcastWeapons or {};\r\nOutcastWeapons.durabilityBuffer = {};\r\n\r\nfunction OutcastWeapons:trackWeaponUse(weapon, damage)\r\n    local modData = weapon:getModData();\r\n    modData[\"OutcastUseCount\"] = (modData[\"OutcastUseCount\"] or 0) + 1;\r\n\r\n    -- Calculate durability loss based on tier\r\n    local tier = modData[\"OutcastTier\"] or \"Common\";\r\n    local durabilityMultiplier = {\r\n        Common = 1.0,\r\n        Rare = 0.8,\r\n        Epic = 0.6,\r\n        Legendary = 0.4\r\n    };\r\n\r\n    local loss = damage * (durabilityMultiplier[tier] or 1.0);\r\n    local newCondition = weapon:getCondition() - loss;\r\n    weapon:setCondition(math.max(0, newCondition));\r\n\r\n    -- Buffer for sync\r\n    OutcastWeapons.durabilityBuffer[weapon:getID()] = newCondition;\r\nend\r\n```\r\n\r\n---\r\n\r\n## 4. Creating Items at Runtime\r\n\r\n### Using InventoryItemFactory\r\n\r\n```lua\r\n-- Create a new item by type\r\nlocal item = InventoryItemFactory.CreateItem(\"Outcast.GraveIndex\");\r\n\r\n-- Add to player inventory\r\nlocal addedItem = player:getInventory():AddItem(item);\r\n\r\n-- Or add directly by type string\r\nlocal addedItem = player:getInventory():AddItem(\"Outcast.GraveIndex\");\r\n```\r\n\r\n### Creating with Custom Properties\r\n\r\n```lua\r\nfunction CreateTieredWeapon(player, baseType, tier)\r\n    -- Create base weapon\r\n    local weapon = player:getInventory():AddItem(baseType);\r\n\r\n    -- Set tier-specific properties via ModData\r\n    local modData = weapon:getModData();\r\n    modData[\"OutcastTier\"] = tier;\r\n    modData[\"OutcastCreatedTime\"] = getTimestamp();\r\n\r\n    -- Set tier-specific condition cap\r\n    local maxCondition = {\r\n        Common = 100,\r\n        Rare = 120,\r\n        Epic = 150,\r\n        Legendary = 200\r\n    };\r\n    weapon:setCondition(maxCondition[tier] or 100);\r\n\r\n    return weapon;\r\nend\r\n```\r\n\r\n---\r\n\r\n## 5. Item Replacement Pattern\r\n\r\n### Complete Item Swap\r\n\r\n```lua\r\nfunction ReplaceWeaponWithTier(player, oldWeapon, newType)\r\n    -- Store old weapon data\r\n    local oldModData = oldWeapon:getModData();\r\n    local oldCondition = oldWeapon:getCondition();\r\n    local wasEquipped = player:getPrimaryHandItem() == oldWeapon;\r\n\r\n    -- Create new weapon\r\n    local newWeapon = InventoryItemFactory.CreateItem(newType);\r\n\r\n    -- Transfer moddata\r\n    local newModData = newWeapon:getModData();\r\n    for key, value in pairs(oldModData) do\r\n        newModData[key] = value;\r\n    end\r\n\r\n    -- Add to inventory\r\n    player:getInventory():AddItem(newWeapon);\r\n\r\n    -- Re-equip if was equipped\r\n    if wasEquipped then\r\n        player:setPrimaryHandItem(newWeapon);\r\n    end\r\n\r\n    -- Remove old weapon\r\n    player:getInventory():Remove(oldWeapon);\r\n\r\n    return newWeapon;\r\nend\r\n```\r\n\r\n---\r\n\r\n## 6. Event-Triggered Transformations\r\n\r\n### On Kill Event\r\n\r\n```lua\r\nEvents.OnZombieDead.Add(function(zombie)\r\n    local player = getPlayer();\r\n    local weapon = player:getPrimaryHandItem();\r\n\r\n    if weapon and IsOutcastWeapon(weapon) then\r\n        local modData = weapon:getModData();\r\n        modData[\"OutcastKillCount\"] = (modData[\"OutcastKillCount\"] or 0) + 1;\r\n\r\n        -- Check for tier upgrade\r\n        CheckTierUpgrade(player, weapon);\r\n    end\r\nend);\r\n\r\nfunction CheckTierUpgrade(player, weapon)\r\n    local modData = weapon:getModData();\r\n    local kills = modData[\"OutcastKillCount\"] or 0;\r\n    local currentTier = modData[\"OutcastTier\"] or \"Common\";\r\n\r\n    local thresholds = {\r\n        Common = {next = \"Rare\", kills = 25},\r\n        Rare = {next = \"Epic\", kills = 50},\r\n        Epic = {next = \"Legendary\", kills = 100}\r\n    };\r\n\r\n    local tierInfo = thresholds[currentTier];\r\n    if tierInfo and kills >= tierInfo.kills then\r\n        -- Perform transformation\r\n        local newType = weapon:getFullType():gsub(currentTier, tierInfo.next);\r\n        ReplaceWeaponWithTier(player, weapon, newType);\r\n\r\n        -- Notify player\r\n        HaloTextHelper.addText(player, \"Weapon evolved to \" .. tierInfo.next .. \"!\", HaloTextHelper.getColorGreen());\r\n    end\r\nend\r\n```\r\n\r\n---\r\n\r\n## Key Takeaways for Grave Index\r\n\r\n1. **Use ModData** for custom properties (tier, kill count, bonuses)\r\n2. **Use InventoryItemFactory** to create new weapon instances\r\n3. **Transfer properties** when replacing weapons\r\n4. **Hook into events** (OnZombieDead, OnWeaponSwing) for triggers\r\n5. **Buffer updates** for multiplayer synchronization\r\n6. **Use clientâ†’server commands** for authoritative changes\r\n",
  "excerpt": "DAMN implements item metamorphosis through crafting, condition-based transformations, and runtime property modification. These patterns are directly applicable to weapon tier transformations.\r\n\r\n--...",
  "lastUpdated": "2026-01-09",
  "difficulty": "intermediate",
  "tableOfContents": [
    {
      "id": "overview",
      "text": "Overview",
      "level": 2
    },
    {
      "id": "1-condition-based-item-transformation",
      "text": "1. Condition-Based Item Transformation",
      "level": 2
    },
    {
      "id": "pattern-create-different-item-based-on-condition",
      "text": "Pattern: Create Different Item Based on Condition",
      "level": 3
    },
    {
      "id": "application-to-weapon-tiers",
      "text": "Application to Weapon Tiers",
      "level": 3
    },
    {
      "id": "2-part-installation-modification",
      "text": "2. Part Installation & Modification",
      "level": 2
    },
    {
      "id": "pattern-silent-part-install-damn_commandslua",
      "text": "Pattern: Silent Part Install (DAMN_Commands.lua)",
      "level": 3
    },
    {
      "id": "application-weapon-attachment-system",
      "text": "Application: Weapon Attachment System",
      "level": 3
    },
    {
      "id": "3-armordurability-modification-system",
      "text": "3. Armor/Durability Modification System",
      "level": 2
    },
    {
      "id": "pattern-buffered-condition-updates-damn_armor_clientlua",
      "text": "Pattern: Buffered Condition Updates (DAMN_Armor_Client.lua)",
      "level": 3
    },
    {
      "id": "application-weapon-durability-system",
      "text": "Application: Weapon Durability System",
      "level": 3
    },
    {
      "id": "4-creating-items-at-runtime",
      "text": "4. Creating Items at Runtime",
      "level": 2
    },
    {
      "id": "using-inventoryitemfactory",
      "text": "Using InventoryItemFactory",
      "level": 3
    },
    {
      "id": "creating-with-custom-properties",
      "text": "Creating with Custom Properties",
      "level": 3
    },
    {
      "id": "5-item-replacement-pattern",
      "text": "5. Item Replacement Pattern",
      "level": 2
    },
    {
      "id": "complete-item-swap",
      "text": "Complete Item Swap",
      "level": 3
    },
    {
      "id": "6-event-triggered-transformations",
      "text": "6. Event-Triggered Transformations",
      "level": 2
    },
    {
      "id": "on-kill-event",
      "text": "On Kill Event",
      "level": 3
    },
    {
      "id": "key-takeaways-for-grave-index",
      "text": "Key Takeaways for Grave Index",
      "level": 2
    }
  ]
}
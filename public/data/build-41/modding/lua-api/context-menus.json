{
  "id": "context-menus",
  "title": "Context Menu System",
  "slug": "context-menus",
  "version": "build-41",
  "section": "modding",
  "category": "lua-api",
  "tags": ["context-menu", "right-click", "ui", "iscontextmenu", "intermediate"],
  "excerpt": "Complete guide to the ISContextMenu system for adding right-click options to world objects and inventory items.",
  "lastUpdated": "2026-01-10",
  "difficulty": "intermediate",
  "tableOfContents": [
    { "id": "overview", "text": "Overview", "level": 2 },
    { "id": "context-menu-events", "text": "Context Menu Events", "level": 2 },
    { "id": "iscontextmenu-api", "text": "ISContextMenu API", "level": 2 },
    { "id": "adding-options", "text": "Adding Options", "level": 3 },
    { "id": "option-properties", "text": "Option Properties", "level": 3 },
    { "id": "submenus", "text": "Submenus", "level": 3 },
    { "id": "tooltips", "text": "Tooltips", "level": 2 },
    { "id": "common-patterns", "text": "Common Patterns", "level": 2 },
    { "id": "related", "text": "Related", "level": 2 }
  ],
  "content": "# Context Menu System\n\n## Overview\n\nThe context menu system is the primary way players interact with the game world and inventory. When you right-click on objects in the world or items in your inventory, these menus appear with available actions.\n\n### System Architecture\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│                    User Right-Click                          │\n│  (World object or Inventory item)                            │\n└──────────────────────────────┬──────────────────────────────┘\n                               │\n                               ▼\n┌─────────────────────────────────────────────────────────────┐\n│                    Event Triggered                           │\n│  OnFillWorldObjectContextMenu / OnFillInventoryObjectContext │\n└──────────────────────────────┬──────────────────────────────┘\n                               │\n                               ▼\n┌─────────────────────────────────────────────────────────────┐\n│            ISContextMenu.get(player, x, y)                   │\n│  Creates/reuses context menu UI at click position            │\n└──────────────────────────────┬──────────────────────────────┘\n                               │\n                               ▼\n┌─────────────────────────────────────────────────────────────┐\n│               Option Population                              │\n│  - Vanilla code adds default options                         │\n│  - Event handlers add mod options                            │\n│  - context:addOption(name, target, callback, params...)      │\n└─────────────────────────────────────────────────────────────┘\n```\n\n### Location\n\n```\nmedia/lua/client/ISUI/ISContextMenu.lua             -- Base class\nmedia/lua/client/ISUI/ISWorldObjectContextMenu.lua  -- World objects\nmedia/lua/client/ISUI/ISInventoryPaneContextMenu.lua -- Inventory items\n```\n\n---\n\n## Context Menu Events\n\n### World Object Context Menu\n\nFires when right-clicking on objects in the world:\n\n```lua\n-- Fires AFTER vanilla options are added (most common)\nEvents.OnFillWorldObjectContextMenu.Add(function(player, context, worldobjects, test)\n    -- player: player index (0-3)\n    -- context: ISContextMenu object\n    -- worldobjects: table of IsoObject\n    -- test: boolean (true if testing menu visibility)\n    \n    if test then return true end  -- Early return for visibility test\n    \n    local playerObj = getSpecificPlayer(player)\n    \n    for _, obj in ipairs(worldobjects) do\n        if instanceof(obj, \"IsoThumpable\") then\n            context:addOption(\"My Action\", obj, myCallback, playerObj)\n        end\n    end\nend)\n```\n\n### Pre-Fill Event\n\nFires BEFORE vanilla options are added:\n\n```lua\nEvents.OnPreFillWorldObjectContextMenu.Add(function(player, context, worldobjects, test)\n    -- Add options at the top of the menu\nend)\n```\n\n### Inventory Context Menu\n\nFires when right-clicking on inventory items:\n\n```lua\nEvents.OnFillInventoryObjectContextMenu.Add(function(player, context, items)\n    -- player: player index (0-3)\n    -- context: ISContextMenu object\n    -- items: table of InventoryItem or {items = {InventoryItem, ...}}\n    \n    local playerObj = getSpecificPlayer(player)\n    \n    -- Handle both single items and stacks\n    for _, v in ipairs(items) do\n        local item = instanceof(v, \"InventoryItem\") and v or v.items[1]\n        \n        if item:getFullType() == \"Base.Hammer\" then\n            context:addOption(\"Special Hammer Action\", item, myCallback, playerObj)\n        end\n    end\nend)\n```\n\n---\n\n## ISContextMenu API\n\n### Getting a Context Menu\n\n```lua\n-- Get or create the player's context menu\nlocal context = ISContextMenu.get(player, x, y)\n\n-- Create a submenu\nlocal subMenu = ISContextMenu:getNew(parentContext)\n```\n\n### Adding Options\n\n```lua\n-- Basic option\nlocal option = context:addOption(\n    name,     -- Display text (string)\n    target,   -- Target object for callback\n    onSelect, -- Callback function\n    param1, param2, param3  -- Up to 10 parameters\n)\n\n-- Callback receives target first, then params\nfunction onSelect(target, param1, param2, param3)\n    -- target is the second argument from addOption\n    -- params follow in order\nend\n```\n\n### Option Properties\n\n```lua\nlocal option = context:addOption(\"My Option\", player, myCallback)\n\n-- Add icon\noption.iconTexture = getTexture(\"media/ui/myicon.png\")\n\n-- Mark as unavailable (greyed out but visible)\noption.notAvailable = true\n\n-- Add checkmark\ncontext:setOptionChecked(option, true)\n```\n\n### Other Methods\n\n```lua\n-- Add option at top of menu\ncontext:addOptionOnTop(name, target, onSelect, ...)\n\n-- Insert after specific option\ncontext:insertOptionAfter(\"Existing Option\", \"New Option\", target, onSelect)\n\n-- Insert before specific option\ncontext:insertOptionBefore(\"Existing Option\", \"New Option\", target, onSelect)\n\n-- Remove option by name\ncontext:removeOptionByName(\"Option Name\")\n\n-- Get option by name\nlocal option = context:getOptionFromName(\"Option Name\")\n\n-- Check if menu is empty\nif context:isEmpty() then ... end\n\n-- Clear all options\ncontext:clear()\n```\n\n### Submenus\n\n```lua\n-- Create submenu\nlocal subMenu = ISContextMenu:getNew(context)\n\n-- Add options to submenu\nsubMenu:addOption(\"Sub Option 1\", target, callback1)\nsubMenu:addOption(\"Sub Option 2\", target, callback2)\n\n-- Add parent option that opens submenu\nlocal option = context:addOption(\"More Options...\")\ncontext:addSubMenu(option, subMenu)\n```\n\n---\n\n## Tooltips\n\n### Creating Tooltips\n\n```lua\n-- Get a tooltip from the pool\nlocal tooltip = ISWorldObjectContextMenu.addToolTip()\n-- or for inventory:\nlocal tooltip = ISInventoryPaneContextMenu.addToolTip()\n\n-- Configure tooltip\ntooltip:setName(\"Action Name\")\ntooltip.description = \"Description text here\"\n\n-- Assign to option\noption.toolTip = tooltip\n```\n\n### Tooltip Formatting\n\n```lua\n-- Multi-line\ntooltip.description = \"Line 1 \\n Line 2\"\n\n-- Colored text using RGB tags\nlocal green = \" <RGB:0,1,0> \"\nlocal red = \" <RGB:1,0,0> \"\nlocal white = \" <RGB:1,1,1> \"\n\ntooltip.description = green .. \"Good!\" .. white .. \" Normal \" .. red .. \"Bad!\"\n\n-- Use game colors\nlocal goodColor = getCore():getGoodHighlitedColor()\nlocal ghs = \" <RGB:\" .. goodColor:getR() .. \",\" \n         .. goodColor:getG() .. \",\" \n         .. goodColor:getB() .. \"> \"\n```\n\n---\n\n## Common Patterns\n\n### World Object with Skill Check\n\n```lua\nEvents.OnFillWorldObjectContextMenu.Add(function(player, context, worldobjects, test)\n    if test then return true end\n    \n    local playerObj = getSpecificPlayer(player)\n    \n    for _, obj in ipairs(worldobjects) do\n        if instanceof(obj, \"IsoThumpable\") then\n            local option = context:addOption(\"Repair\", obj, onRepair, playerObj)\n            \n            -- Check skill requirement\n            local carpentry = playerObj:getPerkLevel(Perks.Woodwork)\n            if carpentry < 3 then\n                option.notAvailable = true\n                local tooltip = ISWorldObjectContextMenu.addToolTip()\n                tooltip.description = \"Requires Carpentry 3 (you have \" .. carpentry .. \")\"\n                option.toolTip = tooltip\n            end\n        end\n    end\nend)\n\nfunction onRepair(obj, playerObj)\n    -- Walk to object then perform action\n    if luautils.walkAdj(playerObj, obj:getSquare()) then\n        ISTimedActionQueue.add(ISRepairAction:new(playerObj, obj, 100))\n    end\nend\n```\n\n### Inventory Item with Submenu\n\n```lua\nEvents.OnFillInventoryObjectContextMenu.Add(function(player, context, items)\n    local playerObj = getSpecificPlayer(player)\n    \n    for _, v in ipairs(items) do\n        local item = instanceof(v, \"InventoryItem\") and v or v.items[1]\n        \n        if item:hasTag(\"Craftable\") then\n            -- Main option with submenu\n            local mainOption = context:addOption(\"Craft With...\")\n            local subMenu = ISContextMenu:getNew(context)\n            context:addSubMenu(mainOption, subMenu)\n            \n            -- Add craft options\n            subMenu:addOption(\"Make Weapon\", item, craftWeapon, playerObj)\n            subMenu:addOption(\"Make Tool\", item, craftTool, playerObj)\n            subMenu:addOption(\"Make Armor\", item, craftArmor, playerObj)\n        end\n    end\nend)\n```\n\n### Dynamic Options Based on State\n\n```lua\nEvents.OnFillWorldObjectContextMenu.Add(function(player, context, worldobjects, test)\n    if test then return true end\n    \n    local playerObj = getSpecificPlayer(player)\n    \n    for _, obj in ipairs(worldobjects) do\n        local modData = obj:getModData()\n        \n        if modData.myMod then\n            if modData.myMod.isActive then\n                -- Show deactivate option\n                context:addOption(\"Deactivate\", obj, onDeactivate, playerObj)\n            else\n                -- Show activate option\n                context:addOption(\"Activate\", obj, onActivate, playerObj)\n            end\n            \n            -- Show settings submenu\n            local settingsOpt = context:addOption(\"Settings...\")\n            local settingsMenu = ISContextMenu:getNew(context)\n            context:addSubMenu(settingsOpt, settingsMenu)\n            \n            -- Toggle options with checkmarks\n            local opt1 = settingsMenu:addOption(\"Auto-run\", obj, toggleAutoRun, playerObj)\n            context:setOptionChecked(opt1, modData.myMod.autoRun)\n            \n            local opt2 = settingsMenu:addOption(\"Silent Mode\", obj, toggleSilent, playerObj)\n            context:setOptionChecked(opt2, modData.myMod.silent)\n        end\n    end\nend)\n```\n\n### Timed Action from Context Menu\n\n```lua\n-- Context menu callback\nfunction onUseWorkbench(obj, playerObj)\n    -- Walk to the object first\n    if luautils.walkAdj(playerObj, obj:getSquare()) then\n        -- Queue the timed action\n        ISTimedActionQueue.add(\n            ISMyWorkbenchAction:new(playerObj, obj, 100)\n        )\n    end\nend\n\n-- The timed action class\nISMyWorkbenchAction = ISBaseTimedAction:derive(\"ISMyWorkbenchAction\")\n\nfunction ISMyWorkbenchAction:new(character, workbench, time)\n    local o = ISBaseTimedAction.new(self, character)\n    o.workbench = workbench\n    o.maxTime = time\n    return o\nend\n\nfunction ISMyWorkbenchAction:isValid()\n    return self.character:getSquare():DistToProper(self.workbench:getSquare()) < 2\nend\n\nfunction ISMyWorkbenchAction:perform()\n    -- Action complete\n    print(\"Used workbench!\")\n    ISBaseTimedAction.perform(self)\nend\n```\n\n---\n\n## Related\n\n- [Events Overview](/build-41/modding/lua-api/events-overview) - Introduction to events\n- [Timed Actions](/build-41/modding/lua-api/timed-actions) - ISBaseTimedAction system\n- [ISUI Overview](/build-41/modding/ui-framework/isui-overview) - UI framework basics"
}
